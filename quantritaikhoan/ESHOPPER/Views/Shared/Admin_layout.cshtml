<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewBag.title - EShopper Modern Admin</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --sidebar-width: 260px;
            --header-height: 70px;
            --primary-color: #6366f1; /* Màu Tím Indigo hiện đại */
            --primary-light: #e0e7ff; /* Màu nền nhạt khi hover */
            --text-dark: #1e293b;     /* Màu chữ xám đậm (Slate 800) */
            --text-muted: #64748b;    /* Màu chữ xám nhạt (Slate 500) */
            --bg-body: #f8fafc;       /* Nền tổng thể xám xanh rất nhạt */
            --card-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); /* Bóng đổ mềm */
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-dark);
            overflow-x: hidden;
        }

        /* --- 1. HEADER (Floating style) --- */
        .app-header {
            height: var(--header-height);
            background: #fff;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            position: fixed;
            top: 0; right: 0; left: 0;
            z-index: 1030;
            display: flex;
            align-items: center;
            padding: 0 2rem;
        }

        .header-brand {
            font-weight: 700;
            font-size: 1.3rem;
            color: var(--text-dark);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .brand-logo-box {
            background: var(--primary-color);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 1rem;
        }

        /* --- 2. SIDEBAR (Modern style) --- */
        .app-sidebar {
            position: fixed;
            top: var(--header-height);
            left: 0;
            bottom: 0;
            width: var(--sidebar-width);
            background: #fff;
            border-right: 1px solid #f1f5f9;
            overflow-y: auto;
            padding: 2rem 1rem;
            transition: transform 0.3s ease-in-out;
            z-index: 1020;
        }

        .sidebar-nav .nav-link {
            color: var(--text-muted);
            padding: 0.85rem 1.2rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            border-radius: 12px;
            transition: all 0.2s ease;
            margin-bottom: 5px;
        }

        .sidebar-nav .nav-link i {
            margin-right: 15px;
            width: 20px;
            text-align: center;
            font-size: 1.1rem;
            transition: color 0.2s;
        }

        .sidebar-nav .nav-link:hover {
            color: var(--primary-color);
            background-color: #f8fafc;
        }
        .sidebar-nav .nav-link.active {
            color: var(--primary-color);
            background-color: var(--primary-light);
            font-weight: 600;
        }
        .sidebar-nav .nav-link.active i { color: var(--primary-color); }

        .sidebar-submenu .nav-link {
            padding-left: 3.5rem;
            font-size: 0.9rem;
            background: transparent !important;
        }
        .sidebar-submenu .nav-link:hover,
        .sidebar-submenu .nav-link.active { color: var(--primary-color); }

        .sidebar-nav .nav-link[data-bs-toggle="collapse"]::after {
            content: "\f107"; font-family: "Font Awesome 6 Free"; font-weight: 900;
            margin-left: auto; transition: transform 0.2s; font-size: 0.8rem;
        }
        .sidebar-nav .nav-link[data-bs-toggle="collapse"][aria-expanded="true"]::after {
            transform: rotate(-180deg);
        }

        /* --- 3. MAIN CONTENT & CARDS --- */
        .app-main {
            margin-top: var(--header-height);
            margin-left: var(--sidebar-width);
            padding: 2.5rem;
            min-height: calc(100vh - var(--header-height));
            transition: margin-left 0.3s ease-in-out;
        }

        .card {
            border: none;
            border-radius: 1rem;
            box-shadow: var(--card-shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            overflow: hidden;
        }
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }
        .card-header {
            background-color: #fff;
            border-bottom: 1px solid #f1f5f9;
            padding: 1.25rem 1.5rem;
            font-weight: 600;
            color: var(--text-dark);
        }
        .card-body { padding: 1.5rem; }

        /* --- RESPONSIVE --- */
        @@media (max-width: 991.98px) {
            .app-sidebar { transform: translateX(-100%); box-shadow: none; }
            .app-sidebar.show { transform: translateX(0); box-shadow: var(--card-shadow); }
            .app-main { margin-left: 0; padding: 1.5rem; }
            .header-brand { margin-right: auto; }
            .sidebar-overlay {
                position: fixed; top: var(--header-height); left: 0; right: 0; bottom: 0;
                background: rgba(255,255,255,0.8);
                backdrop-filter: blur(4px);
                z-index: 1015; display: none;
            }
            .sidebar-overlay.show { display: block; }
        }

        .btn-icon {
            width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%;
            color: var(--text-muted);
            transition: all 0.2s;
        }
        .btn-icon:hover { background-color: #f1f5f9; color: var(--primary-color); }
    </style>
</head>
<body>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <header class="app-header justify-content-between">
        <div class="d-flex align-items-center">
            <button class="btn btn-link text-dark p-0 me-3 d-lg-none" type="button" id="sidebarToggle">
                <i class="fa-solid fa-bars fs-4"></i>
            </button>
            <a href="@Url.Action("dashboard","admin")" class="header-brand">
                <span class="brand-logo-box">E</span>
                <span>Shopper</span>
            </a>
        </div>

        <ul class="nav align-items-center gap-2">
            <li class="nav-item d-none d-md-block">
                <a class="nav-link btn-icon" href="#" id="fullscreen-toggle" title="Toàn màn hình">
                    <i class="fa-solid fa-expand"></i>
                </a>
            </li>
            <li class="nav-item me-2">
                <a class="nav-link btn-icon position-relative" href="#">
                    <i class="fa-regular fa-bell"></i>
                    <span class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle">
                        <span class="visually-hidden">New alerts</span>
                    </span>
                </a>
            </li>

            <li class="nav-item dropdown ps-2" id="user-nav-dropdown">
                <a class="nav-link d-flex align-items-center gap-2 p-0" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <div class="rounded-circle d-flex align-items-center justify-content-center text-white fw-bold shadow-sm"
                         style="width: 40px; height: 40px; background-color: #94a3b8; font-size: 1.1rem;">
                        A
                    </div>
                </a>
                <ul class="dropdown-menu dropdown-menu-end shadow border-0 mt-3 p-2" style="border-radius: 12px; min-width: 200px;">
                    <li><h6 class="dropdown-header">Xin chào, Admin</h6></li>
                    <li><a class="dropdown-item rounded-3 px-3 py-2 mb-1" href="#"><i class="fa-regular fa-user me-2 text-muted"></i> Hồ sơ</a></li>
                    <li><a class="dropdown-item rounded-3 px-3 py-2 mb-1" href="#"><i class="fa-solid fa-gear me-2 text-muted"></i> Cài đặt</a></li>
                    <li><hr class="dropdown-divider my-2"></li>
                    <li><a class="dropdown-item rounded-3 px-3 py-2 text-danger fw-medium" href="#" id="logoutBtnStatic"><i class="fa-solid fa-right-from-bracket me-2"></i> Đăng xuất</a></li>
                </ul>
            </li>
        </ul>
    </header>

    <aside class="app-sidebar" id="appSidebar">
        <nav class="sidebar-nav">
            <ul class="nav flex-column gap-1">
                <li class="nav-item px-3 mb-2 text-uppercase fw-bold" style="font-size: 0.7rem; color: var(--text-muted); letter-spacing: 1px;">
                    Tổng quan
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="@Url.Action("dashboard", "admin")">
                        <i class="fa-solid fa-gauge-high"></i>
                        <span>Dashboard</span>
                    </a>
                </li>

                <li class="nav-item px-3 mt-4 mb-2 text-uppercase fw-bold" style="font-size: 0.7rem; color: var(--text-muted); letter-spacing: 1px;">
                    Quản lý
                </li>

                <li class="nav-item">
                    <a class="nav-link collapsed" href="#order-submenu" data-bs-toggle="collapse" role="button" aria-expanded="false">
                        <i class="fa-solid fa-cart-shopping"></i>
                        <span>Đơn hàng</span>
                    </a>
                    <div class="collapse sidebar-submenu" id="order-submenu">
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                @*<a class="nav-link" href="#">Danh sách đơn</a>*@
                            </li>
                        </ul>
                    </div>
                </li>

                <li class="nav-item">
                    <a class="nav-link collapsed" href="#product-submenu" data-bs-toggle="collapse" role="button" aria-expanded="false">
                        <i class="fa-solid fa-box-archive"></i>
                        <span>Sản phẩm</span>
                    </a>
                    <div class="collapse sidebar-submenu" id="product-submenu">
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                @*<a class="nav-link" href="@Url.Action("Index", "SanPhams", new { area = "" })">Tất cả sản phẩm</a>*@
                            </li>
                            <li class="nav-item">
                                @*<a class="nav-link" href="@Url.Action("Create", "SanPhams", new { area = "" })">Thêm mới</a>*@
                            </li>
                        </ul>
                    </div>
                </li>
                @if (User.IsInRole("Admin"))
                {
                    <li class="nav-item px-3 mt-4 mb-2 text-uppercase fw-bold" style="font-size: 0.7rem; color: var(--text-muted); letter-spacing: 1px;">
                        Cài đặt
                    </li>

                    <li class="nav-item">
                        <a class="nav-link collapsed" href="#account-submenu" data-bs-toggle="collapse" role="button" aria-expanded="false">
                            <i class="fa-solid fa-user-gear"></i>
                            <span>Tài khoản</span>
                        </a>
                        <div class="collapse sidebar-submenu" id="account-submenu">
                            <ul class="nav flex-column">
                                <li class="nav-item">
                                    <a class="nav-link" href="@Url.Action("Index", "Account", new { area = "" })">Danh sách</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="@Url.Action("Create", "Account", new { area = "" })">Thêm mới</a>
                                </li>
                            </ul>
                        </div>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link collapsed" href="#kh-submenu" data-bs-toggle="collapse" role="button" aria-expanded="false">
                            <i class="fa-solid fa-user-gear"></i>
                            <span>Khách hàng</span>
                        </a>
                        <div class="collapse sidebar-submenu" id="kh-submenu">
                            <ul class="nav flex-column">
                                <li class="nav-item">
                                    <a class="nav-link" href="@Url.Action("Index", "Customer", new { area = "" })">Danh sách</a>
                                </li>

                            </ul>
                        </div>
                    </li>
                }
                else {
                    
                }



            </ul>
        </nav>
    </aside>

    <main class="app-main">
        <div class="row g-4 mb-4">
        </div>
        <div class="container-fluid p-0">
            @RenderBody()
        </div>
    </main>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // --- 1. Mobile Toggle ---
            const sidebar = document.getElementById('appSidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            function toggleMobileMenu() {
                sidebar.classList.toggle('show');
                sidebarOverlay.classList.toggle('show');
            }
            if (sidebarToggle) sidebarToggle.addEventListener('click', toggleMobileMenu);
            if (sidebarOverlay) sidebarOverlay.addEventListener('click', toggleMobileMenu);

            // --- 2. Fullscreen ---
            const fullscreenButton = document.getElementById("fullscreen-toggle");
            if (fullscreenButton) {
                const fullscreenIcon = fullscreenButton.querySelector("i");
                fullscreenButton.addEventListener("click", (e) => {
                    e.preventDefault();
                    if (!document.fullscreenElement) {
                        document.documentElement.requestFullscreen().then(() => {
                            fullscreenIcon.classList.replace("fa-expand", "fa-compress");
                        }).catch(err => console.log(err));
                    } else {
                        if (document.exitFullscreen) document.exitFullscreen().then(() => {
                            fullscreenIcon.classList.replace("fa-compress", "fa-expand");
                        });
                    }
                });
            }

            // --- 3. JWT User Info & Logout Logic ---
            const token = localStorage.getItem("jwtToken");
            const userDropdown = document.getElementById("user-nav-dropdown");
            const adminLoginUrl = "/Auth/Login";

            // Xử lý đăng xuất (Hàm chung)
            function handleLogout(e) {
                e.preventDefault();
                if (confirm("Bạn có chắc chắn muốn đăng xuất?")) {
                    localStorage.removeItem("jwtToken");
                    window.location.href = adminLoginUrl;
                }
            }

            // Gán sự kiện cho nút Logout tĩnh (nút có sẵn trong HTML)
            const staticLogoutBtn = document.getElementById("logoutBtnStatic");
            if (staticLogoutBtn) staticLogoutBtn.addEventListener("click", handleLogout);

            // Nếu có Token, cập nhật Avatar (hoặc giữ nguyên style nếu muốn)
            if (token) {
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    const userName = payload.UserName || payload.name || payload.email || "Admin";
                    const firstLetter = userName.charAt(0).toUpperCase();

                    // Cập nhật lại HTML nếu muốn hiển thị đúng tên User từ Token
                    // Ở đây tôi giữ cấu trúc HTML giống hệt cái tĩnh, chỉ thay chữ cái A bằng firstLetter
                    userDropdown.innerHTML = `
                            <a class="nav-link d-flex align-items-center gap-2 p-0" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <div class="rounded-circle d-flex align-items-center justify-content-center text-white fw-bold shadow-sm"
                                     style="width: 40px; height: 40px; background-color: #94a3b8; font-size: 1.1rem;">
                                    ${firstLetter}
                                </div>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end shadow border-0 mt-3 p-2" style="border-radius: 12px; min-width: 200px;">
                                <li><h6 class="dropdown-header">Xin chào, ${userName}</h6></li>
                                <li><a class="dropdown-item rounded-3 px-3 py-2 mb-1" href="/Admin/Profile"><i class="fa-regular fa-user me-2 text-muted"></i> Hồ sơ</a></li>
                                <li><a class="dropdown-item rounded-3 px-3 py-2 mb-1" href="/Admin/Settings"><i class="fa-solid fa-gear me-2 text-muted"></i> Cài đặt</a></li>
                                <li><hr class="dropdown-divider my-2"></li>
                                <li><a class="dropdown-item rounded-3 px-3 py-2 text-danger fw-medium" href="#" id="logoutBtnDynamic"><i class="fa-solid fa-right-from-bracket me-2"></i> Đăng xuất</a></li>
                            </ul>
                        `;

                    // Gán lại sự kiện cho nút logout mới sinh ra
                    document.getElementById("logoutBtnDynamic").addEventListener("click", handleLogout);

                } catch (err) {
                    console.error("JWT Error", err);
                    // localStorage.removeItem("jwtToken"); // Optional: Auto logout if token invalid
                }
            }
        });
    </script>

    <script>
        const revenueData = {
            labels: ["T1", "T2", "T3", "T4", "T5", "T6", "T7"],
            datasets: [{
                label: "Doanh thu",
                data: [65, 59, 80, 81, 56, 55, 90],
                borderColor: "#6366f1",
                backgroundColor: (context) => {
                    const ctx = context.chart.ctx;
                    const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                    gradient.addColorStop(0, "rgba(99, 102, 241, 0.3)");
                    gradient.addColorStop(1, "rgba(99, 102, 241, 0)");
                    return gradient;
                },
                tension: 0.4,
                fill: true,
                pointBackgroundColor: "#ffffff",
                pointBorderColor: "#6366f1",
                pointBorderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6
            }]
        };

        const productData = {
            labels: ["Xe Đạp Đua", "Xe Đạp Địa Hình", "Xe Đạp Trẻ Em"],
            datasets: [{
                data: [300, 150, 100],
                backgroundColor: ["#6366f1", "#14b8a6", "#f59e0b"],
                borderWidth: 0,
                hoverOffset: 5
            }]
        };

        document.addEventListener("DOMContentLoaded", () => {
            Chart.defaults.font.family = "'Poppins', sans-serif";
            Chart.defaults.color = "#64748b";
            Chart.defaults.scale.grid.color = "#f1f5f9";

            const ctxRevenue = document.getElementById("revenueChart");
            if (ctxRevenue) new Chart(ctxRevenue, {
                type: "line", data: revenueData,
                options: {
                    plugins: { legend: { display: false } },
                    scales: { x: { grid: { display: false } }, y: { border: { display: false } } }
                }
            });

            const ctxProduct = document.getElementById("productPieChart");
            if (ctxProduct) new Chart(ctxProduct, {
                type: "doughnut", data: productData,
                options: { cutout: '70%', plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } } } }
            });
        });
    </script>
</body>
</html>