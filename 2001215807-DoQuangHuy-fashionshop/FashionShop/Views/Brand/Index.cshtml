@model FashionShop.Models.ViewModels.BrandFormModel
@{
    ViewBag.Title = "Quản lý Hãng Thời Trang";
    Layout = "~/Views/Shared/Shared_View_Admin.cshtml";
}

<link rel="stylesheet" href="~/Admin_Template/Brand.css" />

@* Alert Message *@
@if (TempData["Message"] != null)
{
    var msg = TempData["Message"] as FashionShop.Models.AlertMessage;
    <div class="alert alert-@(msg.Type == "success" ? "success" : msg.Type == "error" ? "danger" : "warning") alert-dismissible fade show position-fixed"
         style="top: 80px; right: 20px; z-index: 9999; min-width: 300px;" role="alert">
        <strong>@(msg.Type == "success" ? "Thành công!" : "Lỗi!")</strong> @msg.Text
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
}

@* Page Breadcrumb *@
<div class="page-breadcrumb">
    <div class="row align-items-center">
        <div class="col-md-6 col-8 align-self-center">
            <h3 class="page-title mb-0 p-0">Quản lý Hãng Thời Trang</h3>
            <div class="d-flex align-items-center">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="@Url.Action("Index", "Home")">Trang chủ</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Hãng thời trang</li>
                    </ol>
                </nav>
            </div>
        </div>
        <div class="col-md-6 col-4 align-self-center">
            <div class="text-right">
                <button type="button" class="btn btn-info btn-rounded" data-toggle="modal" data-target="#helpModal">
                    <i data-feather="help-circle" class="feather-sm"></i> Trợ giúp
                </button>
            </div>
        </div>
    </div>
</div>

@* Main Content *@
<div class="container-fluid">
    <div class="row">
        @* ============================================================== *@
        @* FORM THÊM/SỬA HÃNG *@
        @* ============================================================== *@
        <div class="col-lg-5 col-xlg-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h4 class="card-title mb-4">
                        <i data-feather="edit" class="feather-icon"></i>
                        <span id="formTitle">@(Model.Form.MaHang == 0 ? "Thêm hãng mới" : "Cập nhật hãng")</span>
                    </h4>

                    @using (Html.BeginForm("AddOrUpdate", "Brand", FormMethod.Post, new { @class = "form-horizontal", id = "brandForm", enctype = "multipart/form-data" }))
                    {
                        @Html.AntiForgeryToken()

                        @* Hidden field cho MaHang (int) *@
                        @Html.HiddenFor(m => m.Form.MaHang, new { id = "MaHang" })
                        @Html.HiddenFor(m => m.Form.TrangThai)

                        @* Tên hãng *@
                        <div class="form-group">
                            <label for="TenHang" class="font-weight-bold">
                                <i data-feather="tag" class="feather-sm text-primary"></i>
                                Tên hãng <span class="text-danger">*</span>
                            </label>
                            @Html.TextBoxFor(m => m.Form.TenHang, new
                            {
                                @class = "form-control form-control-lg",
                                placeholder = "Nhập tên hãng thời trang",
                                id = "TenHang",
                                required = "required"
                            })
                            @Html.ValidationMessageFor(m => m.Form.TenHang, "", new { @class = "text-danger small" })
                        </div>

                        @* Xuất xứ *@
                        <div class="form-group">
                            <label for="XuatXu" class="font-weight-bold">
                                <i data-feather="map-pin" class="feather-sm text-success"></i>
                                Xuất xứ
                            </label>
                            @Html.TextBoxFor(m => m.Form.XuatXu, new
                            {
                                @class = "form-control",
                                placeholder = "Ví dụ: Việt Nam, Hàn Quốc, Nhật Bản...",
                                id = "XuatXu"
                            })
                        </div>

                        @* Website *@
                        <div class="form-group">
                            <label for="Website" class="font-weight-bold">
                                <i data-feather="globe" class="feather-sm text-info"></i>
                                Website
                            </label>
                            @Html.TextBoxFor(m => m.Form.Website, new
                            {
                                @class = "form-control",
                                placeholder = "https://example.com",
                                type = "url",
                                id = "Website"
                            })
                            @Html.ValidationMessageFor(m => m.Form.Website, "", new { @class = "text-danger small" })
                        </div>

                        @* Logo Upload *@
                        <div class="form-group">
                            <label for="LogoFile" class="font-weight-bold">
                                <i data-feather="image" class="feather-sm text-warning"></i>
                                Logo
                            </label>
                            <div class="custom-file">
                                <input type="file" class="custom-file-input" id="LogoFile" name="LogoFile" accept="image/*" onchange="previewLogo(this)">
                                <label class="custom-file-label" for="LogoFile">Chọn hình ảnh logo...</label>
                            </div>
                            <small class="form-text text-muted">
                                <i data-feather="info" class="feather-sm"></i>
                                Chấp nhận: JPG, PNG, GIF (Tối đa 2MB)
                            </small>

                            @* Preview logo mới *@
                            <div id="logoPreview" class="mt-3" style="display: none;">
                                <img id="logoPreviewImg" src="" alt="Logo preview" class="img-thumbnail" style="max-width: 150px; max-height: 150px; object-fit: cover;">
                                <button type="button" class="btn btn-sm btn-danger ml-2" onclick="removeLogo()">
                                    <i data-feather="x" class="feather-sm"></i> Xóa
                                </button>
                            </div>

                            @* Logo hiện tại khi edit *@
                            @if (!string.IsNullOrEmpty(Model.Form.Logo))
                            {
                                <div class="mt-3" id="currentLogo">
                                    <label class="d-block">Logo hiện tại:</label>
                                    <img src="@Model.Form.Logo" alt="Current logo" class="img-thumbnail" style="max-width: 150px; max-height: 150px; object-fit: cover;">
                                    @Html.HiddenFor(m => m.Form.Logo)
                                </div>
                            }
                        </div>

                        @* Mô tả *@
                        <div class="form-group">
                            <label for="MoTa" class="font-weight-bold">
                                <i data-feather="file-text" class="feather-sm text-secondary"></i>
                                Mô tả
                            </label>
                            @Html.TextAreaFor(m => m.Form.MoTa, new
                            {
                                @class = "form-control",
                                rows = "4",
                                placeholder = "Nhập mô tả về hãng...",
                                id = "MoTa"
                            })
                        </div>

                        <div class="form-group">
                            <div class="custom-control custom-switch">
                                @Html.CheckBoxFor(m => m.Form.TrangThai, new
                                {
                                    @class = "custom-control-input",
                                    id = "TrangThai",
                                    @checked = "checked"
                                })
                                <label class="custom-control-label font-weight-bold" for="TrangThai">
                                    <i data-feather="toggle-right" class="feather-sm text-success"></i>
                                    Đang hoạt động
                                </label>
                                <small class="form-text text-muted">
                                    Bỏ tích nếu muốn tạm ngưng kinh doanh hãng này
                                </small>
                            </div>
                        </div>


                        @* Submit Buttons *@
                        <div class="form-group mt-4">
                            <button type="submit" class="btn btn-primary btn-lg btn-block waves-effect waves-light">
                                <i data-feather="save" class="feather-sm"></i>
                                <span id="btnSubmitText">@(Model.Form.MaHang == 0 ? "Thêm hãng" : "Cập nhật")</span>
                            </button>
                            @if (Model.Form.MaHang > 0)
                            {
                                <a href="@Url.Action("Clear", "Brand")" class="btn btn-secondary btn-lg btn-block waves-effect">
                                    <i data-feather="x-circle" class="feather-sm"></i>
                                    Hủy chỉnh sửa
                                </a>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>

        @* ============================================================== *@
        @* BẢNG DANH SÁCH HÃNG *@
        @* ============================================================== *@
        <div class="col-lg-7 col-xlg-8">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="card-title mb-0">
                            <i data-feather="list" class="feather-icon"></i>
                            Danh sách hãng
                            <span class="badge badge-primary badge-pill ml-2">@Model.List.Count</span>
                        </h4>
                        <div class="input-group" style="max-width: 300px;">
                            <input type="text" id="searchInput" class="form-control" placeholder="Tìm kiếm hãng...">
                            <div class="input-group-append">
                                <span class="input-group-text bg-primary text-white">
                                    <i data-feather="search" class="feather-sm"></i>
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover table-striped v-middle" id="brandTable">
                            <thead class="bg-light">
                                <tr>
                                    <th class="border-top-0" style="width: 60px;">
                                        <div class="custom-control custom-checkbox">
                                            <input type="checkbox" class="custom-control-input" id="checkAll">
                                            <label class="custom-control-label" for="checkAll"></label>
                                        </div>
                                    </th>
                                    <th class="border-top-0" style="width: 80px;">Logo</th>
                                    <th class="border-top-0">Tên hãng</th>
                                    <th class="border-top-0">Xuất xứ</th>
                                    <th class="border-top-0">Website</th>
                                    <th class="border-top-0 text-center" style="width: 100px;">Trạng thái</th>
                                    <th class="border-top-0 text-center" style="width: 120px;">Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.List != null && Model.List.Count > 0)
                                {
                                    foreach (var item in Model.List)
                                    {
                                        <tr>
                                            <td>
                                                <div class="custom-control custom-checkbox">
                                                    <input type="checkbox" class="custom-control-input brand-checkbox"
                                                           id="check_@item.MaHang" value="@item.MaHang">
                                                    <label class="custom-control-label" for="check_@item.MaHang"></label>
                                                </div>
                                            </td>
                                            <td>
                                                @if (!string.IsNullOrEmpty(item.Logo))
                                                {
                                                    <img src="@item.Logo" alt="@item.TenHang"
                                                         class="img-thumbnail" style="width: 50px; height: 50px; object-fit: cover;"
                                                         onerror="this.src='/Admin_Template/assets/images/logo-icon.png'">
                                                }
                                                else
                                                {
                                                    <div class="bg-light text-center" style="width: 50px; height: 50px; line-height: 50px;">
                                                        <i data-feather="image" class="feather-icon text-muted"></i>
                                                    </div>
                                                }
                                            </td>
                                            <td>
                                                <h6 class="mb-0 font-weight-medium">@item.TenHang</h6>
                                                @if (!string.IsNullOrEmpty(item.MoTa))
                                                {
                                                    <small class="text-muted">
                                                        @(item.MoTa.Length > 50 ? item.MoTa.Substring(0, 50) + "..." : item.MoTa)
                                                    </small>
                                                }
                                            </td>
                                            <td>
                                                @if (!string.IsNullOrEmpty(item.XuatXu))
                                                {
                                                    <span class="badge badge-info badge-pill">
                                                        <i data-feather="map-pin" class="feather-sm"></i>
                                                        @item.XuatXu
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">---</span>
                                                }
                                            </td>
                                            <td>
                                                @if (!string.IsNullOrEmpty(item.Website))
                                                {
                                                    <a href="@item.Website" target="_blank" class="text-primary"
                                                       data-toggle="tooltip" title="Mở website">
                                                        <i data-feather="external-link" class="feather-sm"></i>
                                                        Link
                                                    </a>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">---</span>
                                                }
                                            </td>
                                            <td class="text-center">
                                                @if (item.TrangThai)
                                                {
                                                    <span class="badge badge-success badge-pill">
                                                        <i data-feather="check-circle" class="feather-sm"></i>
                                                        Hoạt động
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="badge badge-secondary badge-pill">
                                                        <i data-feather="x-circle" class="feather-sm"></i>
                                                        Ngưng
                                                    </span>
                                                }
                                            </td>
                                            <td class="text-center">
                                                <div class="btn-group" role="group">
                                                    <a href="@Url.Action("Edit", "Brand", new { id = item.MaHang })"
                                                       class="btn btn-sm btn-outline-primary"
                                                       data-toggle="tooltip" title="Chỉnh sửa">
                                                        <i data-feather="edit-2" class="feather-sm"></i>
                                                    </a>
                                                    <button type="button"
                                                            class="btn btn-sm btn-outline-danger"
                                                            data-toggle="tooltip" title="Xóa"
                                                            onclick="confirmDelete(@item.MaHang, '@Html.Raw(item.TenHang.Replace("'", "\\'"))')">
                                                        <i data-feather="trash-2" class="feather-sm"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="7" class="text-center py-5">
                                            <i data-feather="inbox" class="feather-icon" style="width: 48px; height: 48px;"></i>
                                            <p class="text-muted mt-2">Chưa có hãng thời trang nào</p>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@* Modal Xác nhận xóa *@
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i data-feather="alert-triangle" class="feather-icon"></i>
                    Xác nhận xóa
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p class="mb-0">Bạn có chắc chắn muốn <strong class="text-danger">XÓA VĨNH VIỄN</strong> hãng <strong id="brandNameToDelete"></strong>?</p>
                <p class="text-danger small mb-0 mt-2">
                    <i data-feather="alert-circle" class="feather-sm"></i>
                    <strong>Cảnh báo:</strong> Hành động này không thể hoàn tác! Hãng sẽ bị xóa hoàn toàn khỏi hệ thống.
                </p>
                <p class="text-warning small mb-0 mt-2">
                    <i data-feather="info" class="feather-sm"></i>
                    Nếu hãng có danh mục hoặc sản phẩm liên quan, việc xóa sẽ thất bại.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i data-feather="x" class="feather-sm"></i> Hủy
                </button>
                <a href="#" id="confirmDeleteBtn" class="btn btn-danger">
                    <i data-feather="trash-2" class="feather-sm"></i> Xóa vĩnh viễn
                </a>
            </div>
        </div>
    </div>
</div>

@* Modal Trợ giúp *@
<div class="modal fade" id="helpModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i data-feather="help-circle" class="feather-icon"></i>
                    Hướng dẫn sử dụng
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <h6 class="font-weight-bold">
                    <i data-feather="plus-circle" class="feather-sm text-success"></i>
                    Thêm hãng mới:
                </h6>
                <ol>
                    <li>Nhập đầy đủ thông tin vào form bên trái (Tên hãng là bắt buộc)</li>
                    <li>Chọn file logo từ máy tính (nếu có) - tối đa 2MB</li>
                    <li>Nhấn nút "Thêm hãng" để lưu</li>
                </ol>

                <h6 class="font-weight-bold mt-3">
                    <i data-feather="edit" class="feather-sm text-primary"></i>
                    Chỉnh sửa hãng:
                </h6>
                <ol>
                    <li>Nhấn vào nút <i data-feather="edit-2" class="feather-sm"></i> ở cột Thao tác</li>
                    <li>Thông tin sẽ hiển thị trong form bên trái</li>
                    <li>Chỉnh sửa các thông tin cần thiết</li>
                    <li>Nhấn "Cập nhật" để lưu thay đổi</li>
                </ol>

                <h6 class="font-weight-bold mt-3">
                    <i data-feather="trash-2" class="feather-sm text-danger"></i>
                    Xóa hãng:
                </h6>
                <ol>
                    <li>Nhấn vào nút <i data-feather="trash-2" class="feather-sm"></i> ở cột Thao tác</li>
                    <li>Xác nhận trong hộp thoại hiện ra</li>
                    <li>Lưu ý: Không thể xóa hãng đã có sản phẩm</li>
                </ol>

                <h6 class="font-weight-bold mt-3">
                    <i data-feather="search" class="feather-sm text-info"></i>
                    Tìm kiếm:
                </h6>
                <p>Sử dụng ô tìm kiếm ở góc trên bên phải để lọc danh sách hãng theo tên, xuất xứ hoặc mô tả.</p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Initialize Feather Icons
            feather.replace();

            // Initialize tooltips
            $('[data-toggle="tooltip"]').tooltip();

            // Auto dismiss alert after 5 seconds
            setTimeout(function () {
                $('.alert').fadeOut('slow');
            }, 5000);

            // Search functionality
            $("#searchInput").on("keyup", function () {
                var value = $(this).val().toLowerCase();
                $("#brandTable tbody tr").filter(function () {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
                });
            });

            // Check all checkboxes
            $("#checkAll").on("click", function () {
                $(".brand-checkbox").prop('checked', $(this).prop('checked'));
            });

            // Custom file input label update
            $('.custom-file-input').on('change', function () {
                var fileName = $(this).val().split('\\').pop();
                $(this).next('.custom-file-label').html(fileName);
            });

            // Update form title when editing
            var maHang = parseInt($('#MaHang').val());
            if (maHang > 0) {
                $("#formTitle").text("Cập nhật hãng");
                $("#btnSubmitText").text("Cập nhật");
            } else {
                $("#formTitle").text("Thêm hãng mới");
                $("#btnSubmitText").text("Thêm hãng");
                // Set default TrangThai = true khi thêm mới
                $('#TrangThai').prop('checked', true);
            }

            // THÊM MỚI: Update label của checkbox khi thay đổi trạng thái
            $('#TrangThai').on('change', function() {
                var label = $(this).next('label').find('i');
                if($(this).is(':checked')) {
                    label.removeClass('text-danger').addClass('text-success');
                    label.attr('data-feather', 'toggle-right');
                } else {
                    label.removeClass('text-success').addClass('text-danger');
                    label.attr('data-feather', 'toggle-left');
                }
                feather.replace();
            });
        });

        // Preview logo before upload
        function previewLogo(input) {
            if (input.files && input.files[0]) {
                if (input.files[0].size > 2097152) {
                    alert('Kích thước file quá lớn! Vui lòng chọn file nhỏ hơn 2MB.');
                    input.value = '';
                    $('.custom-file-label').html('Chọn hình ảnh logo...');
                    return;
                }

                // Check file type
                var fileType = input.files[0].type;
                if (!fileType.match('image.*')) {
                    alert('Vui lòng chọn file hình ảnh!');
                    input.value = '';
                    $('.custom-file-label').html('Chọn hình ảnh logo...');
                    return;
                }

                var reader = new FileReader();
                reader.onload = function (e) {
                    $('#logoPreviewImg').attr('src', e.target.result);
                    $('#logoPreview').show();
                    $('#currentLogo').hide();
                    feather.replace();
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Remove logo preview
        function removeLogo() {
            $('#LogoFile').val('');
            $('.custom-file-label').html('Chọn hình ảnh logo...');
            $('#logoPreview').hide();
            $('#logoPreviewImg').attr('src', '');
            $('#currentLogo').show();
        }

        // Confirm delete function - GỌI sp_DeleteBrand
        function confirmDelete(maHang, tenHang) {
            $('#brandNameToDelete').text(tenHang);
            $('#confirmDeleteBtn').attr('href', '@Url.Action("Delete", "Brand")' + '?id=' + maHang);
            $('#deleteModal').modal('show');

            // Refresh feather icons in modal
            setTimeout(function() {
                feather.replace();
            }, 100);
        }

        // Form validation
        $("#brandForm").on("submit", function (e) {
            var tenHang = $("#TenHang").val().trim();

            if (tenHang === "") {
                e.preventDefault();
                alert("Vui lòng nhập tên hãng!");
                $("#TenHang").focus();
                return false;
            }

            // Validate website format if provided
            var website = $("#Website").val().trim();
            if (website !== "" && !isValidUrl(website)) {
                e.preventDefault();
                alert("Định dạng website không hợp lệ! Ví dụ: https://example.com");
                $("#Website").focus();
                return false;
            }

            return true;
        });

        // Validate URL format
        function isValidUrl(string) {
            try {
                var pattern = new RegExp('^(https?:\\/\\/)?' +
                    '((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|' +
                    '((\\d{1,3}\\.){3}\\d{1,3}))' +
                    '(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*' +
                    '(\\?[;&a-z\\d%_.~+=-]*)?' +
                    '(\\#[-a-z\\d_]*)?$', 'i');
                return !!pattern.test(string);
            } catch (e) {
                return false;
            }
        }

        if (window.history.replaceState) {
            window.history.replaceState(null, null, window.location.href);
        }
    </script>
}