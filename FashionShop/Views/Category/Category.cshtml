@model FashionShop.Models.ViewModels.CategoryFormModel
@{
    ViewBag.Title = "Quản lý Danh mục";
    Layout = "~/Views/Shared/Shared_View_Admin.cshtml";
}

<link href="~/Admin_Template/Category.css" rel="stylesheet" />

<div class="category-management-container">
    <!-- Header -->
    <div class="header">
        <h1>
            <i class="fas fa-layer-group"></i>
            Quản lý Danh mục Sản phẩm
        </h1>
        <p class="mb-0">Quản lý các danh mục sản phẩm của cửa hàng thời trang</p>
    </div>

    <!-- Alert Messages -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle"></i> @TempData["SuccessMessage"]
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle"></i> @TempData["ErrorMessage"]
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    }

    <!-- Form Card -->
    <div class="modern-card">
        <div class="card-header">
            <h5 id="formTitle">
                <i class="fas fa-plus-circle"></i>
                @(Model.Form.Category_Id > 0 ? "Sửa Danh mục" : "Thêm Danh mục Mới")
            </h5>
        </div>
        <div class="card-body">
            @using (Html.BeginForm("AddOrUpdate", "Category", FormMethod.Post,
                new { enctype = "multipart/form-data", id = "categoryForm" }))
            {
                @Html.AntiForgeryToken()
                @Html.HiddenFor(m => m.Form.Category_Id)
                @Html.HiddenFor(m => m.Form.CategoryImageUrl)

                <div class="row">
                    <!-- Tên danh mục -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Tên Danh mục <span class="text-danger">*</span></label>
                            @Html.TextBoxFor(m => m.Form.CategoryName, new
                            {
                                @class = "form-control",
                                placeholder = "Nhập tên danh mục",
                                required = "required"
                            })
                        </div>
                    </div>

                    <!-- Slug -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Slug (URL thân thiện)</label>
                            @Html.TextBoxFor(m => m.Form.CategorySlug, new
                            {
                                @class = "form-control",
                                placeholder = "vd: ao-thun-nam (tự động tạo)"
                            })
                            <small class="form-text text-muted">
                                <i class="fas fa-info-circle"></i> Để trống để tự động tạo từ tên danh mục
                            </small>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Thương hiệu -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Thương hiệu</label>
                            @Html.DropDownListFor(m => m.Form.Brand_Id,
                                new SelectList(Model.Brands, "MaHang", "TenHang", Model.Form.Brand_Id),
                                "-- Chọn thương hiệu (không bắt buộc) --",
                                new { @class = "form-control" })
                        </div>
                    </div>

                    <!-- Sort Order -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Thứ tự sắp xếp</label>
                            @Html.TextBoxFor(m => m.Form.SortOrder, new
                            {
                                @class = "form-control",
                                type = "number",
                                min = "0",
                                placeholder = "0"
                            })
                            <small class="form-text text-muted">Số càng nhỏ hiển thị càng trước</small>
                        </div>
                    </div>
                </div>

                <!-- Mô tả -->
                <div class="form-group">
                    <label>Mô tả</label>
                    @Html.TextAreaFor(m => m.Form.Description, new
                    {
                        @class = "form-control",
                        rows = "3",
                        placeholder = "Nhập mô tả ngắn về danh mục..."
                    })
                </div>

                <div class="row">
                    <!-- Upload hình ảnh -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Hình ảnh đại diện</label>
                            <div class="custom-file">
                                @Html.TextBoxFor(m => m.Form.ImageFile, new
                                {
                                    type = "file",
                                    @class = "custom-file-input",
                                    id = "imageFile",
                                    accept = "image/*"
                                })
                                <label class="custom-file-label" for="imageFile">Chọn hình ảnh</label>
                            </div>
                            <small class="form-text text-muted">
                                <i class="fas fa-info-circle"></i> Chỉ chấp nhận JPG, PNG, GIF (tối đa 5MB)
                            </small>
                        </div>
                    </div>

                    <!-- Xem trước hình ảnh -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Xem trước</label>
                            <div class="image-preview-container">
                                <img id="imagePreview"
                                     src="@(string.IsNullOrEmpty(Model.Form.CategoryImageUrl) ? "/Content/Images/no-image.png" : Model.Form.CategoryImageUrl)"
                                     class="img-thumbnail image-preview">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Checkboxes -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-check custom-checkbox">
                            @Html.CheckBoxFor(m => m.Form.IsActive, new { @class = "form-check-input", id = "isActive" })
                            <label class="form-check-label" for="isActive">
                                <i class="fas fa-toggle-on"></i> Kích hoạt
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check custom-checkbox">
                            @Html.CheckBoxFor(m => m.Form.IsFeatured, new { @class = "form-check-input", id = "isFeatured" })
                            <label class="form-check-label" for="isFeatured">
                                <i class="fas fa-star"></i> Danh mục nổi bật
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Buttons -->
                <div class="button-group mt-4">
                    <button type="submit" class="btn btn-success btn-icon">
                        <i class="fas fa-save"></i>
                        @(Model.Form.Category_Id > 0 ? "Cập nhật" : "Thêm mới")
                    </button>
                    <a href="@Url.Action("Category", "Category")" class="btn btn-secondary btn-icon">
                        <i class="fas fa-times"></i> Hủy
                    </a>
                </div>
            }
        </div>
    </div>

    <!-- List Card -->
    <div id="categoryListContainer" class="modern-card">
        <div class="card-header">
            <h5><i class="fas fa-list"></i> Danh sách Danh mục</h5>
        </div>
        <div class="card-body">
            <!-- Table -->
            <div class="table-responsive">
                <table class="table table-hover table-striped">
                    <thead class="thead-dark">
                        <tr>
                            <th width="5%">ID</th>
                            <th width="10%">Hình ảnh</th>
                            <th width="20%">Tên danh mục</th>
                            <th width="15%">Thương hiệu</th>
                            <th width="10%">Thứ tự</th>
                            <th width="10%">Trạng thái</th>
                            <th width="15%">Ngày tạo</th>
                            <th width="15%">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.List != null && Model.List.Any())
                        {
                            foreach (var item in Model.List)
                            {
                                <tr>
                                    <td class="text-center">@item.Category_Id</td>
                                    <td class="text-center">
                                        @if (!string.IsNullOrEmpty(item.CategoryImageUrl))
                                        {
                                            <img src="@item.CategoryImageUrl"
                                                 alt="@item.CategoryName"
                                                 class="table-img">
                                        }
                                        else
                                        {
                                            <img src="/Content/Images/no-image.png"
                                                 alt="No image"
                                                 class="table-img">
                                        }
                                    </td>
                                    <td>
                                        <strong>@item.CategoryName</strong><br />
                                        <small class="text-muted">
                                            <i class="fas fa-link"></i> @item.CategorySlug
                                        </small>
                                        @if (item.IsFeatured)
                                        {
                                            <br /><span class="badge badge-warning"><i class="fas fa-star"></i> Nổi bật</span>
                                        }
                                    </td>
                                    <td>
                                        @if (item.Brand != null)
                                        {
                                            <span class="badge badge-info">@item.Brand.TenHang</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">N/A</span>
                                        }
                                    </td>
                                    <td class="text-center">
                                        <span class="badge badge-secondary">@item.SortOrder</span>
                                    </td>
                                    <td class="text-center">
                                        @if (item.IsActive)
                                        {
                                            <span class="badge badge-success">
                                                <i class="fas fa-check"></i> Hoạt động
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge badge-danger">
                                                <i class="fas fa-times"></i> Không hoạt động
                                            </span>
                                        }
                                    </td>
                                    <td class="text-center">@item.CreatedDate.ToString("dd/MM/yyyy")</td>
                                    <td class="text-center">
                                        <div class="btn-group" role="group">
                                            <a href="@Url.Action("Edit", "Category", new { id = item.Category_Id })"
                                               class="btn btn-sm btn-warning"
                                               title="Sửa">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            @using (Html.BeginForm("Delete", "Category", new { id = item.Category_Id }, FormMethod.Post, new { style = "display:inline;" }))
                                            {
                                                @Html.AntiForgeryToken()
                                                <button type="submit"
                                                        class="btn btn-sm btn-danger"
                                                        onclick="return confirm('Bạn có chắc chắn muốn xóa danh mục này?');"
                                                        title="Xóa">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="8" class="text-center text-muted">
                                    <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                                    <p>Chưa có danh mục nào</p>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            @if (ViewBag.TotalPages > 1)
            {
                <div class="pagination-container">
                    <nav aria-label="Page navigation">
                        <ul class="pagination mb-0">
                            @{
                                int currentPage = ViewBag.CurrentPage ?? 1;
                                int totalPages = ViewBag.TotalPages ?? 1;
                                int pageSize = ViewBag.PageSize ?? 10;
                            }

                            <!-- Previous Button -->
                            <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                                <a class="page-link"
                                   href="@Url.Action("Category", new { page = currentPage - 1, pageSize = pageSize })">
                                    <i class="fas fa-chevron-left"></i> Trước
                                </a>
                            </li>

                            <!-- Page Numbers -->
                            @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
                            {
                                <li class="page-item @(i == currentPage ? "active" : "")">
                                    <a class="page-link"
                                       href="@Url.Action("Category", new { page = i, pageSize = pageSize })">
                                        @i
                                    </a>
                                </li>
                            }

                            <!-- Next Button -->
                            <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                                <a class="page-link"
                                   href="@Url.Action("Category", new { page = currentPage + 1, pageSize = pageSize })">
                                    Sau <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                        </ul>
                    </nav>

                    <!-- Pagination Info -->
                    <div class="pagination-info">
                        <small class="text-muted">
                            Hiển thị @((currentPage - 1) * pageSize + 1) - @(Math.Min(currentPage * pageSize, ViewBag.TotalItems ?? 0))
                            trong tổng số <strong>@(ViewBag.TotalItems ?? 0)</strong> danh mục
                        </small>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
    $(document).ready(function() {
        // Preview image when file selected
        $('#imageFile').on('change', function() {
            var fileName = $(this).val().split('\\').pop();
            $(this).next('.custom-file-label').text(fileName || 'Chọn hình ảnh');

            if (this.files && this.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    $('#imagePreview').attr('src', e.target.result);
                }
                reader.readAsDataURL(this.files[0]);
            }
        });

        // Auto-hide alerts after 5 seconds
        setTimeout(function() {
            $('.alert').fadeOut('slow');
        }, 5000);

        // Confirm before delete
        $('form').on('submit', function(e) {
            if ($(this).attr('action').indexOf('Delete') > -1) {
                if (!confirm('Bạn có chắc chắn muốn xóa danh mục này?')) {
                    e.preventDefault();
                    return false;
                }
            }
        });
    });
    </script>
}