@model FashionShop.Models.ViewModels.ProductFormModel
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/Shared_View_Admin.cshtml";
}

<link rel="stylesheet" href="~/Admin_Template/Product.css"/>

<div class="page-wrapper">
    <div class="container-fluid">
        @* Alert Message *@
        @if (TempData["Message"] != null)
        {
            var msg = TempData["Message"] as FashionShop.Models.AlertMessage;
            <div class="alert alert-@(msg.Type == "success" ? "success" : msg.Type == "error" ? "danger" : "warning") alert-dismissible fade show position-fixed"
                 style="top: 80px; right: 20px; z-index: 9999; min-width: 300px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);" role="alert">
                <strong>@(msg.Type == "success" ? "✓ Thành công!" : "✗ Lỗi!")</strong> @msg.Text
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        }

        @* Page Breadcrumb *@
        <div class="page-breadcrumb bg-white" style="border-radius: 12px; margin-bottom: 20px; padding: 15px;">
            <div class="row align-items-center">
                <div class="col-md-6 col-8 align-self-center">
                    <h2 class="page-title mb-0 p-0" style="color: #2c3e50; font-weight: 600;">
                        <i data-feather="package" class="feather-icon" style="color: #007bff;"></i>
                        Quản lý Sản Phẩm
                    </h2>
                    <div class="d-flex align-items-center mt-2">
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb mb-0 bg-transparent">
                                <li class="breadcrumb-item"><a href="@Url.Action("Index", "Admin")">Dashboard</a></li>
                                <li class="breadcrumb-item active" aria-current="page">Sản phẩm</li>
                            </ol>
                        </nav>
                    </div>
                </div>
                <div class="col-md-6 col-4 align-self-center">
                    <div class="text-right">
                        <button type="button" class="btn btn-info btn-modern" data-toggle="modal" data-target="#helpModal">
                            <i data-feather="help-circle" class="feather-sm"></i>
                            <span class="d-none d-md-inline">Trợ giúp</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        @* Statistics Cards *@
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 animate-in">
                <div class="stats-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-0" style="font-size: 2rem; font-weight: 700;">@Model.List.Count</h3>
                            <p class="mb-0 mt-2" style="opacity: 0.9;">Tổng sản phẩm</p>
                        </div>
                        <i data-feather="package" style="width: 48px; height: 48px; opacity: 0.5;"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 animate-in" style="animation-delay: 0.1s;">
                <div class="stats-card green">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-0" style="font-size: 2rem; font-weight: 700;">@Model.List.Count(p => p.TrangThai)</h3>
                            <p class="mb-0 mt-2" style="opacity: 0.9;">Đang kinh doanh</p>
                        </div>
                        <i data-feather="trending-up" style="width: 48px; height: 48px; opacity: 0.5;"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 animate-in" style="animation-delay: 0.2s;">
                <div class="stats-card orange">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-0" style="font-size: 2rem; font-weight: 700;">@Model.List.Count(p => p.SoLuong > 0 && p.SoLuong <= 10)</h3>
                            <p class="mb-0 mt-2" style="opacity: 0.9;">Sắp hết hàng</p>
                        </div>
                        <i data-feather="alert-triangle" style="width: 48px; height: 48px; opacity: 0.5;"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 animate-in" style="animation-delay: 0.3s;">
                <div class="stats-card red">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-0" style="font-size: 2rem; font-weight: 700;">@Model.List.Count(p => p.SoLuong == 0)</h3>
                            <p class="mb-0 mt-2" style="opacity: 0.9;">Hết hàng</p>
                        </div>
                        <i data-feather="x-circle" style="width: 48px; height: 48px; opacity: 0.5;"></i>
                    </div>
                </div>
            </div>
        </div>

        @* Main Content *@
        <div class="row">
            @* ============================================ *@
            @* FORM THÊM/SỬA SẢN PHẨM *@
            @* ============================================ *@
            <div class="col-lg-4">
                <div class="card form-modern">
                    <div class="card-body">
                        <h4 class="card-title mb-4" style="color: #2c3e50; font-weight: 600;">
                            <i data-feather="edit" class="feather-icon" style="color: #007bff;"></i>
                            <span id="formTitle">@(Model.Form.MaSP == 0 ? "Thêm sản phẩm mới" : "Cập nhật sản phẩm")</span>
                        </h4>

                        @using (Html.BeginForm("AddOrUpdate", "Product", FormMethod.Post, new { @class = "form-horizontal", id = "productForm", enctype = "multipart/form-data" }))
                        {
                            @Html.AntiForgeryToken()
                            @Html.HiddenFor(m => m.Form.MaSP, new { id = "MaSP" })
                            @Html.HiddenFor(m => m.Form.TrangThai)

                            @* Image Upload *@
                            <div class="form-group">
                                <label class="font-weight-bold">
                                    <i data-feather="image" class="feather-sm text-primary"></i>
                                    Hình ảnh sản phẩm
                                </label>
                                <div class="image-preview-wrapper" id="imagePreviewWrapper" onclick="$('#ImageFile').click()">
                                    @if (!string.IsNullOrEmpty(Model.Form.HinhAnh))
                                    {
                                        <img src="@Model.Form.HinhAnh" alt="Product" id="imagePreview">
                                        @Html.HiddenFor(m => m.Form.HinhAnh)
                                    }
                                    else
                                    {
                                        <div class="text-center">
                                            <i data-feather="upload-cloud" class="upload-icon"></i>
                                            <p class="text-muted mt-2">Nhấn để chọn ảnh</p>
                                        </div>
                                    }
                                </div>
                                <input type="file" id="ImageFile" name="ImageFile" accept="image/*" style="display: none;" onchange="previewImage(this)">
                                <small class="form-text text-muted">
                                    <i data-feather="info" class="feather-sm"></i>
                                    JPG, PNG, GIF, WEBP (Tối đa 5MB)
                                </small>
                            </div>

                            @* Product Name *@
                            <div class="form-group">
                                <label for="TenSP" class="font-weight-bold">
                                    <i data-feather="tag" class="feather-sm text-primary"></i>
                                    Tên sản phẩm <span class="text-danger">*</span>
                                </label>
                                @Html.TextBoxFor(m => m.Form.TenSP, new
                                {
                                    @class = "form-control form-control-modern",
                                    placeholder = "Nhập tên sản phẩm",
                                    id = "TenSP",
                                    required = "required"
                                })
                                @Html.ValidationMessageFor(m => m.Form.TenSP, "", new { @class = "text-danger small" })
                            </div>

                            @* Category & Brand *@
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="MaDanhMuc" class="font-weight-bold">
                                            <i data-feather="grid" class="feather-sm text-success"></i>
                                            Danh mục <span class="text-danger">*</span>
                                        </label>
                                        @Html.DropDownListFor(m => m.Form.MaDanhMuc, Model.Categories, "-- Chọn danh mục --", new { @class = "form-control form-control-modern", id = "MaDanhMuc", required = "required" })
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="MaHang" class="font-weight-bold">
                                            <i data-feather="award" class="feather-sm text-warning"></i>
                                            Hãng
                                        </label>
                                        @Html.DropDownListFor(m => m.Form.MaHang, Model.Brands, "-- Chọn hãng --", new { @class = "form-control form-control-modern", id = "MaHang" })
                                    </div>
                                </div>
                            </div>

                            @* Price & Sale Price *@
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="Gia" class="font-weight-bold">
                                            <i data-feather="dollar-sign" class="feather-sm text-success"></i>
                                            Giá gốc <span class="text-danger">*</span>
                                        </label>
                                        @Html.TextBoxFor(m => m.Form.Gia, new
                                        {
                                            @class = "form-control form-control-modern",
                                            type = "number",
                                            step = "0.01",
                                            min = "0",
                                            placeholder = "0",
                                            id = "Gia",
                                            required = "required"
                                        })
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="GiaKM" class="font-weight-bold">
                                            <i data-feather="percent" class="feather-sm text-danger"></i>
                                            Giá KM
                                        </label>
                                        @Html.TextBoxFor(m => m.Form.GiaKM, new
                                        {
                                            @class = "form-control form-control-modern",
                                            type = "number",
                                            step = "0.01",
                                            min = "0",
                                            placeholder = "0",
                                            id = "GiaKM"
                                        })
                                    </div>
                                </div>
                            </div>

                            @* Quantity *@
                            <div class="form-group">
                                <label for="SoLuong" class="font-weight-bold">
                                    <i data-feather="package" class="feather-sm text-info"></i>
                                    Số lượng <span class="text-danger">*</span>
                                </label>
                                @Html.TextBoxFor(m => m.Form.SoLuong, new
                                {
                                    @class = "form-control form-control-modern",
                                    type = "number",
                                    min = "0",
                                    placeholder = "0",
                                    id = "SoLuong",
                                    required = "required"
                                })
                            </div>

                            @* Color & Size *@
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="MaMau" class="font-weight-bold">
                                            <i data-feather="droplet" class="feather-sm text-primary"></i>
                                            Màu sắc
                                        </label>
                                        @Html.DropDownListFor(m => m.Form.MaMau, Model.Colors, "-- Chọn màu --", new { @class = "form-control form-control-modern", id = "MaMau" })
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="MaSize" class="font-weight-bold">
                                            <i data-feather="maximize" class="feather-sm text-secondary"></i>
                                            Kích thước
                                        </label>
                                        @Html.DropDownListFor(m => m.Form.MaSize, Model.Sizes, "-- Chọn size --", new { @class = "form-control form-control-modern", id = "MaSize" })
                                    </div>
                                </div>
                            </div>

                            @* Short Description *@
                            <div class="form-group">
                                <label for="MoTaNgan" class="font-weight-bold">
                                    <i data-feather="align-left" class="feather-sm text-secondary"></i>
                                    Mô tả ngắn
                                </label>
                                @Html.TextAreaFor(m => m.Form.MoTaNgan, new
                                {
                                    @class = "form-control form-control-modern",
                                    rows = "2",
                                    placeholder = "Mô tả ngắn về sản phẩm...",
                                    id = "MoTaNgan"
                                })
                            </div>

                            @* Full Description *@
                            <div class="form-group">
                                <label for="MoTaChiTiet" class="font-weight-bold">
                                    <i data-feather="file-text" class="feather-sm text-secondary"></i>
                                    Mô tả chi tiết
                                </label>
                                @Html.TextAreaFor(m => m.Form.MoTaChiTiet, new
                                {
                                    @class = "form-control form-control-modern",
                                    rows = "3",
                                    placeholder = "Mô tả chi tiết về sản phẩm...",
                                    id = "MoTaChiTiet"
                                })
                            </div>

                            @* Status *@
                            <div class="form-group">
                                <div class="custom-control custom-switch">
                                    @Html.CheckBoxFor(m => m.Form.TrangThai, new
                                    {
                                        @class = "custom-control-input",
                                        id = "TrangThai",
                                        @checked = "checked"
                                    })
                                    <label class="custom-control-label font-weight-bold" for="TrangThai">
                                        <i data-feather="toggle-right" class="feather-sm text-success"></i>
                                        Đang kinh doanh
                                    </label>
                                </div>
                            </div>

                            @* Submit Buttons *@
                            <div class="form-group mt-4">
                                <button type="submit" class="btn btn-primary btn-lg btn-block btn-modern">
                                    <i data-feather="save" class="feather-sm"></i>
                                    <span id="btnSubmitText">@(Model.Form.MaSP == 0 ? "Thêm sản phẩm" : "Cập nhật")</span>
                                </button>
                                @if (Model.Form.MaSP > 0)
                                {
                                    <a href="@Url.Action("Clear", "Product")" class="btn btn-secondary btn-lg btn-block btn-modern">
                                        <i data-feather="x-circle" class="feather-sm"></i>
                                        Hủy chỉnh sửa
                                    </a>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>

            @* ============================================ *@
            @* PRODUCT LIST *@
            @* ============================================ *@
            <div class="col-lg-8">
                <div class="card form-modern">
                    <div class="card-body">
                        @* Header Controls *@
                        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
                            <div class="d-flex align-items-center mb-2 mb-md-0">
                                <h4 class="card-title mb-0" style="color: #2c3e50; font-weight: 600;">
                                    <i data-feather="list" class="feather-icon" style="color: #007bff;"></i>
                                    Danh sách sản phẩm
                                    <span class="badge badge-primary badge-pill ml-2">@Model.List.Count</span>
                                </h4>
                            </div>

                            <div class="d-flex align-items-center">
                                @* View Toggle *@
                                <div class="btn-group mr-3" role="group">
                                    <button type="button" class="grid-view-btn active" onclick="switchView('grid')">
                                        <i data-feather="grid" class="feather-sm"></i>
                                    </button>
                                    <button type="button" class="list-view-btn" onclick="switchView('list')">
                                        <i data-feather="list" class="feather-sm"></i>
                                    </button>
                                </div>

                                @* Search *@
                                <div class="input-group" style="max-width: 250px;">
                                    <input type="text" id="searchInput" class="form-control form-control-modern" placeholder="Tìm kiếm...">
                                    <div class="input-group-append">
                                        <span class="input-group-text bg-primary text-white" style="border-radius: 0 8px 8px 0;">
                                            <i data-feather="search" class="feather-sm"></i>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        @* Filters *@
                        <div class="mb-4">
                            <div class="d-flex flex-wrap align-items-center">
                                <span class="mr-2 font-weight-bold">Lọc:</span>
                                <span class="filter-chip active" data-filter="all">Tất cả</span>
                                <span class="filter-chip" data-filter="active">Đang bán</span>
                                <span class="filter-chip" data-filter="low-stock">Sắp hết</span>
                                <span class="filter-chip" data-filter="out-stock">Hết hàng</span>
                                <span class="filter-chip" data-filter="sale">Giảm giá</span>
                            </div>
                        </div>

                        @* Product Grid *@
                        <div id="productGrid" class="row">
                            @if (Model.List != null && Model.List.Count > 0)
                            {
                                foreach (var item in Model.List)
                                {
                                    var stockClass = item.SoLuong == 0 ? "out-stock" : (item.SoLuong <= 10 ? "low-stock" : "in-stock");
                                    var statusClass = item.TrangThai ? "active" : "inactive";
                                    var saleClass = item.GiaKM.HasValue && item.GiaKM.Value > 0 ? "sale" : "";

                                    <div class="col-lg-4 col-md-6 mb-4 product-item animate-in"
                                         data-filter="@stockClass @statusClass @saleClass"
                                         data-name="@item.TenSP.ToLower()"
                                         data-category="@(item.TenDanhMuc ?? "")">
                                        <div class="product-card">
                                            <div class="position-relative" style="overflow: hidden;">
                                                @if (!string.IsNullOrEmpty(item.HinhAnh))
                                                {
                                                    <img src="@item.HinhAnh" alt="@item.TenSP" class="product-image" onerror="this.src='/Admin_Template/assets/images/big/img1.jpg'">
                                                }
                                                else
                                                {
                                                    <div style="width: 100%; height: 200px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center;">
                                                        <i data-feather="image" style="width: 64px; height: 64px; color: white; opacity: 0.5;"></i>
                                                    </div>
                                                }

                                                @* Badges *@
                                                <div class="product-badge">
                                                    @if (item.GiaKM.HasValue && item.GiaKM.Value > 0 && item.Gia > 0)
                                                    {
                                                        var discount = ((item.Gia - item.GiaKM.Value) / item.Gia * 100);
                                                        <span class="badge badge-danger" style="font-size: 0.9rem;">-@discount.ToString("0")%</span>
                                                    }
                                                </div>

                                                @* Quick Actions *@
                                                <div class="product-actions">
                                                    <div class="btn-group-vertical">
                                                        <a href="@Url.Action("Edit", "Product", new { id = item.MaSP })"
                                                           class="btn btn-sm btn-primary"
                                                           data-toggle="tooltip"
                                                           title="Chỉnh sửa">
                                                            <i data-feather="edit-2" class="feather-sm"></i>
                                                        </a>
                                                        <button type="button"
                                                                class="btn btn-sm btn-danger"
                                                                data-toggle="tooltip"
                                                                title="Xóa"
                                                                onclick="confirmDelete(@item.MaSP, '@Html.Raw(item.TenSP.Replace("'", "\\'"))')">
                                                            <i data-feather="trash-2" class="feather-sm"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="card-body">
                                                <h6 class="mb-2 font-weight-bold text-truncate" style="color: #2c3e50;">@item.TenSP</h6>

                                                @if (!string.IsNullOrEmpty(item.TenDanhMuc))
                                                {
                                                    <p class="text-muted small mb-2">
                                                        <i data-feather="grid" class="feather-sm"></i>
                                                        @item.TenDanhMuc
                                                        @if (!string.IsNullOrEmpty(item.TenHang))
                                                        {
                                                            <span> • @item.TenHang</span>
                                                        }
                                                    </p>
                                                }

                                                @* Price *@
                                                <div class="mb-2">
                                                    @if (item.GiaKM.HasValue && item.GiaKM.Value > 0)
                                                    {
                                                        <div>
                                                            <span class="price-sale">@item.GiaKM.Value.ToString("N0") đ</span>
                                                            <span class="price-original ml-2">@item.Gia.ToString("N0") đ</span>
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <span class="price-normal">@item.Gia.ToString("N0") đ</span>
                                                    }
                                                </div>

                                                @* Stock & Status *@
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <span class="stock-badge @(item.SoLuong == 0 ? "stock-out" : (item.SoLuong <= 10 ? "stock-low" : "stock-in"))">
                                                        <i data-feather="package" class="feather-sm"></i>
                                                        @item.SoLuong
                                                    </span>

                                                    @if (item.TrangThai)
                                                    {
                                                        <span class="badge badge-success">
                                                            <i data-feather="check-circle" class="feather-sm"></i>
                                                            Đang bán
                                                        </span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge badge-secondary">
                                                            <i data-feather="x-circle" class="feather-sm"></i>
                                                            Ngưng
                                                        </span>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="col-12">
                                    <div class="text-center py-5">
                                        <i data-feather="inbox" style="width: 64px; height: 64px; color: #adb5bd;"></i>
                                        <p class="text-muted mt-3" style="font-size: 1.1rem;">Chưa có sản phẩm nào</p>
                                    </div>
                                </div>
                            }
                        </div>

                        @* List View (Hidden by default) *@
                        <div id="productList" class="table-responsive" style="display: none;">
                            <table class="table table-hover" id="productTable">
                                <thead class="bg-light">
                                    <tr>
                                        <th style="width: 80px;">Hình</th>
                                        <th>Sản phẩm</th>
                                        <th>Danh mục</th>
                                        <th>Giá</th>
                                        <th>SL</th>
                                        <th>Trạng thái</th>
                                        <th class="text-center" style="width: 120px;">Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (Model.List != null && Model.List.Count > 0)
                                    {
                                        foreach (var item in Model.List)
                                        {
                                            <tr class="product-row" data-name="@item.TenSP.ToLower()">
                                                <td>
                                                    @if (!string.IsNullOrEmpty(item.HinhAnh))
                                                    {
                                                        <img src="@item.HinhAnh" alt="@item.TenSP"
                                                             class="img-thumbnail"
                                                             style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;"
                                                             onerror="this.src='/Admin_Template/assets/images/big/img1.jpg'">
                                                    }
                                                    else
                                                    {
                                                        <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                                            <i data-feather="image" style="width: 24px; height: 24px; color: white;"></i>
                                                        </div>
                                                    }
                                                </td>
                                                <td>
                                                    <h6 class="mb-1 font-weight-medium">@item.TenSP</h6>
                                                    @if (!string.IsNullOrEmpty(item.MoTaNgan))
                                                    {
                                                        <small class="text-muted">@(item.MoTaNgan.Length > 50 ? item.MoTaNgan.Substring(0, 50) + "..." : item.MoTaNgan)</small>
                                                    }
                                                </td>
                                                <td>
                                                    @if (!string.IsNullOrEmpty(item.TenDanhMuc))
                                                    {
                                                        <span class="badge badge-info">@item.TenDanhMuc</span>
                                                    }
                                                    @if (!string.IsNullOrEmpty(item.TenHang))
                                                    {
                                                        <br /><small class="text-muted">@item.TenHang</small>
                                                    }
                                                </td>
                                                <td>
                                                    @if (item.GiaKM.HasValue && item.GiaKM.Value > 0)
                                                    {
                                                        <div>
                                                            <strong class="text-danger">@item.GiaKM.Value.ToString("N0")đ</strong><br />
                                                            <small class="text-muted"><del>@item.Gia.ToString("N0")đ</del></small>
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <strong class="text-success">@item.Gia.ToString("N0")đ</strong>
                                                    }
                                                </td>
                                                <td>
                                                    <span class="stock-badge @(item.SoLuong == 0 ? "stock-out" : (item.SoLuong <= 10 ? "stock-low" : "stock-in"))">
                                                        @item.SoLuong
                                                    </span>
                                                </td>
                                                <td>
                                                    @if (item.TrangThai)
                                                    {
                                                        <span class="badge badge-success">
                                                            <i data-feather="check-circle" class="feather-sm"></i>
                                                            Đang bán
                                                        </span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge badge-secondary">
                                                            <i data-feather="x-circle" class="feather-sm"></i>
                                                            Ngưng
                                                        </span>
                                                    }
                                                </td>
                                                <td class="text-center">
                                                    <div class="btn-group" role="group">
                                                        <a href="@Url.Action("Edit", "Product", new { id = item.MaSP })"
                                                           class="btn btn-sm btn-outline-primary"
                                                           data-toggle="tooltip"
                                                           title="Chỉnh sửa">
                                                            <i data-feather="edit-2" class="feather-sm"></i>
                                                        </a>
                                                        <button type="button"
                                                                class="btn btn-sm btn-outline-danger"
                                                                data-toggle="tooltip"
                                                                title="Xóa"
                                                                onclick="confirmDelete(@item.MaSP, '@Html.Raw(item.TenSP.Replace("'", "\\'"))')">
                                                            <i data-feather="trash-2" class="feather-sm"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@* Delete Confirmation Modal *@
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content" style="border-radius: 12px; border: none;">
            <div class="modal-header bg-danger text-white" style="border-radius: 12px 12px 0 0;">
                <h5 class="modal-title">
                    <i data-feather="alert-triangle" class="feather-icon"></i>
                    Xác nhận xóa
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p class="mb-0">Bạn có chắc chắn muốn <strong class="text-danger">XÓA</strong> sản phẩm <strong id="productNameToDelete"></strong>?</p>
                <p class="text-danger small mb-0 mt-2">
                    <i data-feather="alert-circle" class="feather-sm"></i>
                    <strong>Cảnh báo:</strong> Hành động này không thể hoàn tác!
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-modern" data-dismiss="modal">
                    <i data-feather="x" class="feather-sm"></i> Hủy
                </button>
                <a href="#" id="confirmDeleteBtn" class="btn btn-danger btn-modern">
                    <i data-feather="trash-2" class="feather-sm"></i> Xóa
                </a>
            </div>
        </div>
    </div>
</div>

@* Help Modal *@
<div class="modal fade" id="helpModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content" style="border-radius: 12px; border: none;">
            <div class="modal-header bg-info text-white" style="border-radius: 12px 12px 0 0;">
                <h5 class="modal-title">
                    <i data-feather="help-circle" class="feather-icon"></i>
                    Hướng dẫn sử dụng
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <h6 class="font-weight-bold">
                    <i data-feather="plus-circle" class="feather-sm text-success"></i>
                    Thêm sản phẩm mới:
                </h6>
                <ol>
                    <li>Nhấn vào khung hình ảnh để chọn ảnh sản phẩm</li>
                    <li>Nhập đầy đủ thông tin (Tên, Danh mục, Giá là bắt buộc)</li>
                    <li>Chọn thêm hãng, màu sắc, kích thước nếu có</li>
                    <li>Nhấn "Thêm sản phẩm" để lưu</li>
                </ol>

                <h6 class="font-weight-bold mt-3">
                    <i data-feather="edit" class="feather-sm text-primary"></i>
                    Chỉnh sửa sản phẩm:
                </h6>
                <ol>
                    <li>Nhấn vào nút <i data-feather="edit-2" class="feather-sm"></i> trên sản phẩm</li>
                    <li>Thông tin sẽ hiển thị trong form bên trái</li>
                    <li>Chỉnh sửa các thông tin cần thiết</li>
                    <li>Nhấn "Cập nhật" để lưu</li>
                </ol>

                <h6 class="font-weight-bold mt-3">
                    <i data-feather="filter" class="feather-sm text-warning"></i>
                    Lọc và tìm kiếm:
                </h6>
                <ul>
                    <li>Sử dụng các filter chip để lọc theo trạng thái</li>
                    <li>Dùng ô tìm kiếm để tìm theo tên sản phẩm</li>
                    <li>Chuyển đổi giữa chế độ xem lưới/danh sách</li>
                </ul>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            feather.replace();
            $('[data-toggle="tooltip"]').tooltip();

            // Auto dismiss alert
            setTimeout(function () {
                $('.alert').fadeOut('slow');
            }, 5000);

            // Update form title
            var maSP = parseInt($('#MaSP').val());
            if (maSP > 0) {
                $("#formTitle").text("Cập nhật sản phẩm");
                $("#btnSubmitText").text("Cập nhật");
            } else {
                $("#formTitle").text("Thêm sản phẩm mới");
                $("#btnSubmitText").text("Thêm sản phẩm");
                $('#TrangThai').prop('checked', true);
            }

            // Search functionality
            $("#searchInput").on("keyup", function () {
                var value = $(this).val().toLowerCase();

                if ($("#productGrid").is(":visible")) {
                    $(".product-item").filter(function () {
                        var name = $(this).data('name');
                        $(this).toggle(name.indexOf(value) > -1);
                    });
                } else {
                    $(".product-row").filter(function () {
                        var name = $(this).data('name');
                        $(this).toggle(name.indexOf(value) > -1);
                    });
                }
                feather.replace();
            });

            // Filter functionality
            $(".filter-chip").on("click", function () {
                $(".filter-chip").removeClass('active');
                $(this).addClass('active');

                var filter = $(this).data('filter');

                if (filter === 'all') {
                    $(".product-item").show();
                } else {
                    $(".product-item").hide();
                    $(".product-item[data-filter*='" + filter + "']").show();
                }
                feather.replace();
            });

            // Status toggle
            $('#TrangThai').on('change', function() {
                var icon = $(this).next('label').find('i');
                if($(this).is(':checked')) {
                    icon.removeClass('text-danger').addClass('text-success');
                    icon.attr('data-feather', 'toggle-right');
                } else {
                    icon.removeClass('text-success').addClass('text-danger');
                    icon.attr('data-feather', 'toggle-left');
                }
                feather.replace();
            });
        });

        // Preview image
        function previewImage(input) {
            if (input.files && input.files[0]) {
                if (input.files[0].size > 5242880) {
                    alert('Kích thước file quá lớn! Vui lòng chọn file nhỏ hơn 5MB.');
                    input.value = '';
                    return;
                }

                var fileType = input.files[0].type;
                if (!fileType.match('image.*')) {
                    alert('Vui lòng chọn file hình ảnh!');
                    input.value = '';
                    return;
                }

                var reader = new FileReader();
                reader.onload = function (e) {
                    $('#imagePreviewWrapper').html('<img src="' + e.target.result + '" alt="Preview" id="imagePreview" style="width: 100%; height: 100%; object-fit: cover;">');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Switch view
        function switchView(view) {
            if (view === 'grid') {
                $('#productGrid').show();
                $('#productList').hide();
                $('.grid-view-btn').addClass('active');
                $('.list-view-btn').removeClass('active');
            } else {
                $('#productGrid').hide();
                $('#productList').show();
                $('.grid-view-btn').removeClass('active');
                $('.list-view-btn').addClass('active');
            }
            feather.replace();
        }

        // Confirm delete
        function confirmDelete(maSP, tenSP) {
            $('#productNameToDelete').text(tenSP);
            $('#confirmDeleteBtn').attr('href', '@Url.Action("Delete", "Product")' + '?id=' + maSP);
            $('#deleteModal').modal('show');
            setTimeout(function() {
                feather.replace();
            }, 100);
        }

        // Form validation
        $("#productForm").on("submit", function (e) {
            var tenSP = $("#TenSP").val().trim();
            var gia = parseFloat($("#Gia").val());
            var giaKM = parseFloat($("#GiaKM").val());

            if (tenSP === "") {
                e.preventDefault();
                alert("Vui lòng nhập tên sản phẩm!");
                $("#TenSP").focus();
                return false;
            }

            if (isNaN(gia) || gia <= 0) {
                e.preventDefault();
                alert("Giá sản phẩm phải lớn hơn 0!");
                $("#Gia").focus();
                return false;
            }

            if (!isNaN(giaKM) && giaKM > 0 && giaKM >= gia) {
                e.preventDefault();
                alert("Giá khuyến mãi phải nhỏ hơn giá gốc!");
                $("#GiaKM").focus();
                return false;
            }

            return true;
        });

        // Prevent form resubmission
        if (window.history.replaceState) {
            window.history.replaceState(null, null, window.location.href);
        }
    </script>
}

